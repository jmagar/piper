# Active Context: Piper Chat Application - CSRF Debugging

**Last Updated**: 2025-05-30 (Current Session)

**Overall Goal**: Resolve the "failed to create chat" error in the Piper application, which is currently manifesting as an "Invalid CSRF token" error when the application is accessed via `http://localhost:8630` (as intended by the user).

## Current Focus & Problem Statement:

Despite setting up the development environment using `dev.sh` (which correctly uses `docker-compose.dev.yml`) and ensuring `npx prisma db push` runs successfully (resolving previous database schema/table issues), creating a new chat results in a "Failed to create chat" UI message. Browser developer tools consistently show a 403 Forbidden error with the message "Invalid CSRF token" for the POST request to `/api/create-chat`.

The investigation has revealed a custom CSRF implementation:
- `middleware.ts` checks for a `csrf_token` cookie and an `x-csrf-token` header. Validation relies on `validateCsrfToken` from `lib/csrf.ts`.
- `lib/csrf.ts` generates and validates tokens using a `CSRF_SECRET` from `process.env.CSRF_SECRET`.
- An API route `app/api/csrf/route.ts` is responsible for generating a CSRF token and setting the `csrf_token` cookie upon a GET request.
- The main layout component (`app/layout-client.tsx`) makes a `fetch` call to `/api/csrf` on load, presumably to ensure the cookie is set.
- A custom `fetchClient` in `lib/fetch.ts` is used for client-side API calls; it reads `document.cookie` to find the `csrf_token` and sends its value in the `x-csrf-token` header.

## Key Changes & Discoveries in This Debugging Thread:

1.  **`CSRF_SECRET` Missing**: Identified that the `.env` file was missing the `CSRF_SECRET` environment variable. This was a critical finding, as the CSRF logic depends on it.
2.  **`CSRF_SECRET` Added**: The `CSRF_SECRET` variable was successfully added to `/mnt/user/compose/piper/.env` with a placeholder value.
3.  **Docker Restart**: The user was instructed to restart the Docker services (`./dev.sh down` then `./dev.sh up -d --build piper-app`) to ensure the `piper-app` service picked up the new `CSRF_SECRET` from the `.env` file.
4.  **Persistent "Invalid CSRF token" Issue**: Even after adding `CSRF_SECRET` and restarting, the user reports the same error.
5.  **Critical Observation - Browser URL vs. Local Dev**: A screenshot provided by the user (related to cookie inspection) showed the browser's context as `https://piper.tootle.tv`, NOT `http://localhost:8630`. This is a major discrepancy. If the browser is making requests to `piper.tootle.tv`, the local `CSRF_SECRET` and any cookies set for `localhost:8630` would be irrelevant to those requests, leading to the CSRF error from the `piper.tootle.tv` server.

## Current Hypothesis:

*   **Primary Hypothesis**: The browser is, for some reason (e.g., old redirect, service worker, bookmark, browser state), making its API requests to `https://piper.tootle.tv` instead of the intended `http://localhost:8630`. CSRF tokens are domain-specific. A token generated by/for `localhost:8630` will not be valid for `piper.tootle.tv`.
*   **Secondary Hypothesis (If primary is disproven and browser is confirmed to be strictly on `localhost:8630` for all requests)**:
    *   The `/api/csrf` endpoint is failing to set the cookie correctly even with `CSRF_SECRET` present (e.g., an error in the API route itself, or cookie attribute issues like `Domain` or `Path` being misconfigured for localhost).
    *   The `fetchClient` is not correctly reading the `csrf_token` from `document.cookie` for `localhost:8630` or not sending the `x-csrf-token` header correctly.
    *   The `CSRF_SECRET` placeholder value itself has characters causing issues (less likely but possible).

## Immediate Next Steps:

1.  **USER ACTION - ABSOLUTELY CRITICAL**: The USER must meticulously perform the following to ensure they are testing against the local development server:
    *   **Close ALL browser tabs** related to Piper, `piper.tootle.tv`, or `localhost:8630`.
    *   **Thoroughly clear ALL browser data**: cache, cookies, site data, service workers. Specifically target `piper.tootle.tv` AND `localhost`.
    *   Open a **brand new incognito/private browsing window**.
    *   In the address bar of this new incognito window, **manually and carefully type `http://localhost:8630`** and press Enter.
    *   Before attempting any action (like creating a chat), open browser developer tools:
        *   **Network Tab**: Keep it open to monitor requests.
        *   **Application Tab (Cookies)**: Check cookies for `localhost:8630`. Verify if `csrf_token` is present after page load.
    *   Attempt to create a chat.
    *   **Observe the Network Tab**: When the "Failed to create chat" error appears, inspect the failed POST request to `/api/create-chat`. CRITICALLY check:
        *   **Request URL**: Is it `http://localhost:8630/api/create-chat` or `https://piper.tootle.tv/api/create-chat`?
        *   **Request Headers**: Is `x-csrf-token` present? What is its value?
        *   **Request Cookies**: Is the `csrf_token` cookie being sent? What is its value and domain?

2.  **If the issue persists AND the Request URL is confirmed to be `http://localhost:8630/api/create-chat`**:
    *   Review the server logs for the `piper-app` container (`./dev.sh logs piper-app`) immediately after the failed request for any errors related to CSRF validation in `middleware.ts` or token generation in `lib/csrf.ts`.
    *   Consider adding temporary `console.log` statements in `middleware.ts` (to see received `csrfCookie` and `headerToken`) and in `app/api/csrf/route.ts` (to confirm token generation and cookie setting) to trace the values. This would require a rebuild of the `piper-app` image.

## Current Blockers:
-   The persistent "Invalid CSRF token" error prevents chat creation.
-   Strong evidence suggests the browser might not be targeting `http://localhost:8630` for API requests, despite user intent. This needs to be definitively confirmed or ruled out by the user.